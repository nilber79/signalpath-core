name: Dependency Version Check

# Checks dependencies that Dependabot cannot track (hard-coded Dockerfile ARGs).
# Opens a GitHub Issue when a newer version is available so the change can be
# reviewed for breaking changes before the Dockerfile is manually updated.

on:
  schedule:
    # Every Monday at 9 AM Eastern (14:00 UTC)
    - cron: '0 14 * * 1'
  workflow_dispatch:

jobs:
  check-plang:
    name: Check pla-ng (phpLiteAdmin)
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Read pinned version from Dockerfile.area
        id: pinned
        run: |
          version=$(grep -oP '(?<=ARG PLANG_VERSION=).*' docker/Dockerfile.area)
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Fetch latest pla-ng release from GitHub API
        id: latest
        run: |
          response=$(curl -sf \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/emanueleg/pla-ng/releases/latest")
          tag=$(echo "$response" | jq -r '.tag_name')
          url=$(echo "$response" | jq -r '.html_url')
          echo "version=$tag" >> $GITHUB_OUTPUT
          echo "url=$url"     >> $GITHUB_OUTPUT

      - name: Open issue if a newer version is available
        if: steps.pinned.outputs.version != steps.latest.outputs.version
        uses: actions/github-script@v7
        with:
          script: |
            const pinned  = '${{ steps.pinned.outputs.version }}';
            const latest  = '${{ steps.latest.outputs.version }}';
            const relUrl  = '${{ steps.latest.outputs.url }}';
            const title   = `pla-ng ${latest} available (pinned: ${pinned})`;

            // Avoid duplicate issues: skip if an open issue with this exact title exists.
            const { data: existing } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              state: 'open',
            });
            if (existing.some(i => i.title === title)) {
              console.log('Issue already exists â€” skipping.');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo:  context.repo.repo,
              title,
              body: [
                '## pla-ng update available',
                '',
                '| | Version |',
                '|---|---|',
                `| **Currently pinned** | \`${pinned}\` |`,
                `| **Latest release**   | \`${latest}\` |`,
                '',
                `**Review release notes and changelog before updating:** ${relUrl}`,
                '',
                '### How to update',
                `Change the \`PLANG_VERSION\` build arg in \`docker/Dockerfile.area\`:`,
                '```',
                `ARG PLANG_VERSION=${latest}`,
                '```',
                '',
                'Close this issue once the Dockerfile has been updated, or add a comment',
                'explaining why this version is being skipped.',
              ].join('\n'),
            });
            console.log(`Issue created: ${title}`);
