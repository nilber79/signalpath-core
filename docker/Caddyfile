{
	# Enable FrankenPHP worker mode for better PHP performance
	frankenphp
}

# SERVER_NAME controls the domain and TLS behaviour:
#   SERVER_NAME=roadstatus.yourcounty.gov   → auto-TLS via Let's Encrypt (port 443)
#   SERVER_NAME=:80                          → HTTP only (use when behind a proxy)
#   SERVER_NAME=localhost                    → local dev, self-signed cert
{$SERVER_NAME:localhost} {
	root * /app/public

	# Streaming endpoints must NOT be gzip-compressed or buffered
	@streaming {
		path /sse.php
		path /api.php
	}
	handle @streaming {
		php_server
	}

	# HTML: never cache — proxies (Cloudflare) must always revalidate so that
	# updated script/style version strings in index.html reach browsers promptly.
	@html {
		path *.html
		path /
	}
	header @html Cache-Control "no-cache, must-revalidate"

	# Versioned static assets (app.js?v=…, style.css?v=…): cache aggressively.
	# The query-string version bump is the cache-bust mechanism.
	@versioned {
		query v=*
	}
	header @versioned Cache-Control "public, max-age=31536000, immutable"

	# Everything else: compress static assets, serve files, process PHP
	encode zstd br gzip
	php_server
}
